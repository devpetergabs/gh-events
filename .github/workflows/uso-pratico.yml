name: Consumes Artifact WF
on:      
    workflow_call:
      inputs:
        nome-arquivo:
            description: 'Nome do arquivo a ser criado'
            default: 'artifact'
            required: false
            type: string
      
jobs:
    gerar-artefato:
        runs-on: ubuntu-latest
        env:
            GITHUB_CONTEXT: ${{ toJson(github) }} 
        outputs:
            archive-name: ${{ steps.set-name-archive.outputs.ARQUIVO_NOME }}  
            name: ${{ steps.set-name.outputs.name }}  
        steps:
            - name: checkout code
              uses: actions/checkout@v4
              
            - name: set name archive
              id: set-name-archive
              run: |
                echo "ARQUIVO_NOME=${{ inputs.nome-arquivo }}.$(date +%Y%m%d%H)" >> $GITHUB_ENV
                echo "ARQUIVO_NOME=${{ inputs.nome-arquivo }}.$(date +%Y%m%d%H)" >> $GITHUB_OUTPUT 


              ##output-var gerado de maneira correta (somente uma fonte de verdade)
            - name: set output filename
              id: set-name
              run: |
                NOME="Gabriel"
                echo "name=$NOME" >> $GITHUB_OUTPUT 
                
            - name: create artifact
              id: create
              env:
                  name: ${{ steps.set-name.outputs.name }}
              run: |
                echo "Creating artifact..."
                echo "Nome do evento acionado - ${{ github.event_name }}" > $name.txt
                echo "Autor - ${{ github.actor }}" > $ARQUIVO_NOME.txt
                echo "aqui pelo step - $name + $ARQUIVO_NOME" >> name-artifact.txt
                
            - name: upload 
              uses: actions/upload-artifact@v4
              with:
                name: sample-artifacts
                path: |
                 name-artifact.txt
                 ${{ env.ARQUIVO_NOME }}.txt
                 ${{ steps.set-name.outputs.name }}.txt
             
    consumir-artefato:
        needs: gerar-artefato
        runs-on: ubuntu-latest
        env:
            name: ${{ needs.gerar-artefato.outputs.name }}
            archive_name: ${{ needs.gerar-artefato.outputs.archive-name }}
        steps:
            - name: download artifact
              uses: actions/download-artifact@v4
              with:
                name: sample-artifacts

            - name: use artifact and outputs        
              run: |
                    echo "Lista de arquivos baixados:"
                    ls -la
                    echo "Conte√∫do dos arquivos baixados:"
                    echo "arquivo de concatenacao: $name + $archive_name"
                    cat name-artifact.txt
                    cat $name.txt
               

                    
                    